<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>艾宾浩斯日历 - 消灭错别字</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4e73df;
            --secondary: #858796;
            --success: #1cc88a;
            --warning: #f6c23e;
            --danger: #e74a3b;
            --light: #f8f9fc;
            --dark: #5a5c69;
            --font-family: 'Noto Sans SC', sans-serif;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #f5f7ff;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            pointer-events: none;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        h1 i {
            font-size: 2rem;
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 50%;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 700px;
        }
        
        /* 状态栏样式 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1.1rem;
            color: var(--dark);
        }
        
        .stat-new .stat-value {
            color: var(--primary);
        }
        
        .stat-review .stat-value {
            color: var(--warning);
        }
        
        .stat-mastered .stat-value {
            color: var(--success);
        }
        
        .calendar-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .calendar-title {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        .nav-buttons button {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            margin: 0 5px;
        }
        
        .nav-buttons button:hover {
            background: #224abe;
            transform: scale(1.1);
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .day {
            height: 100px;
            background: #f8f9fc;
            border-radius: 8px;
            padding: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .day:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1rem;
            position: absolute;
            top: 5px;
            left: 5px;
        }
        
        .today {
            background: #eef2ff;
            border-color: var(--primary);
        }
        
        /* 圆圈指示器样式 */
        .day-indicators {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 4px;
            margin-top: 10px;
        }
        
        .indicator {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .indicator-blue {
            background: var(--primary);
        }
        
        .indicator-yellow {
            background: var(--warning);
        }
        
        .indicator-red {
            background: var(--danger);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-date-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            flex: 1;
            text-align: center;
            white-space: nowrap;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            font-family: var(--font-family);
            height: 100px;
            resize: vertical;
        }
        
        .input-hint {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-top: 5px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-family: var(--font-family);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #224abe;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c03427;
        }
        
        .review-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .review-item.need-review {
            background: #fff9e6;
            border-left: 4px solid var(--warning);
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .review-content {
            font-size: 1.3rem;
            margin: 15px 0;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
        }
        
        .need-review .review-content {
            font-weight: 700;
            color: #d35400;
            background-color: #fff5e6;
            border: 2px solid #ffcc80;
        }
        
        .review-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
            flex: 1;
        }
        
        .btn-success:hover {
            background: #17a673;
        }
        
        .review-stats {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .stat-correct {
            color: var(--success);
        }
        
        .stat-wrong {
            color: var(--danger);
        }
        
        .no-content {
            text-align: center;
            padding: 30px;
            color: var(--secondary);
            background: #f8f9fc;
            border-radius: 8px;
        }
        
        .history-list {
            margin-top: 15px;
            padding: 10px;
            background: #f0f4f8;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #ccc;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: var(--secondary);
            font-size: 0.9rem;
            margin-top: 30px;
        }
        
        .content-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* 内容项包装器 */
        .content-item-wrapper {
            margin-bottom: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            overflow: hidden;
            background: #f9f9f9;
        }
        
        .content-item {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .content-text {
            flex: 1;
            padding-right: 10px;
        }
        
        /* 删除图标样式 */
        .delete-icon {
            color: var(--danger);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 8px;
            border-radius: 4px;
            -webkit-appearance: none;
            appearance: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            transition: background-color 0.2s;
            cursor: pointer; /* iOS需要这个 */
        }
        
        .delete-icon:hover {
            background-color: rgba(231, 74, 59, 0.1);
        }
        
        .delete-icon i {
            pointer-events: none;
        }
        
        /* 删除确认区域 */
        .delete-confirm-area {
            background: #ffebee;
            padding: 10px;
            border-top: 1px solid #ffcdd2;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .delete-confirm-area.show {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .delete-confirm-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }
        
        .btn-confirm-delete {
            background: var(--danger);
            color: white;
        }
        
        .btn-confirm-delete:hover {
            background: #c03427;
        }
        
        .btn-cancel-delete {
            background: #6c757d;
            color: white;
        }
        
        .btn-cancel-delete:hover {
            background: #5a6268;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--success);
            border-radius: 5px;
            transition: width 0.5s;
        }
        
        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--dark);
            margin-top: 5px;
        }
        
        .review-feedback {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            padding: 8px;
            border-radius: 5px;
        }
        
        .review-feedback.correct {
            background-color: rgba(28, 200, 138, 0.1);
            color: var(--success);
        }
        
        .review-feedback.wrong {
            background-color: rgba(231, 74, 59, 0.1);
            color: var(--danger);
        }
        
        .reviewed-item {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #f9f9f9;
        }
        
        .reviewed-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .reviewed-content {
            font-size: 1.2rem;
            margin: 10px 0;
            text-align: center;
            padding: 8px;
            border-radius: 5px;
        }
        
        .reviewed-result {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-weight: 600;
        }
        
        .reviewed-correct {
            color: var(--success);
        }
        
        .reviewed-wrong {
            color: var(--danger);
        }
        
        .reviewed-progress {
            text-align: center;
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        /* 已学会内容项样式 */
        .mastered-item {
            padding: 15px;
            border: 2px solid var(--success);
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f0fff5;
        }
        
        .mastered-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .mastered-content {
            font-size: 1.4rem;
            margin: 15px 0;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            background: #e8f5e9;
            font-weight: bold;
            color: #1b5e20;
        }
        
        .mastered-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        .mastered-badge {
            background: var(--success);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .mastered-progress {
            text-align: center;
            margin-top: 10px;
        }
        
        /* 听写控制面板样式 */
        .dictation-controls {
            background: #f8f9fc;
            border: 1px solid #e3e6f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .dictation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e3e6f0;
        }
        
        .dictation-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dictation-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #6c757d;
        }
        
        .status-indicator.active {
            background-color: var(--success);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .dictation-settings {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .setting-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark);
        }
        
        .setting-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: #e3e6f0;
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .dictation-buttons {
            display: flex;
            gap: 10px;
        }
        
        .dictation-buttons .btn {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
        }
        
        .btn-start-dictation {
            background: var(--success);
            color: white;
        }
        
        .btn-start-dictation:hover {
            background: #17a673;
        }
        
        .btn-stop-dictation {
            background: var(--danger);
            color: white;
        }
        
        .btn-stop-dictation:hover {
            background: #c03427;
        }
        
        .btn-pause-dictation {
            background: var(--warning);
            color: white;
        }
        
        .btn-pause-dictation:hover {
            background: #e0a800;
        }
        
        .current-dictation {
            text-align: center;
            margin-top: 15px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 2px solid var(--primary);
        }
        
        .dictation-word {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dictation-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        .compatibility-check {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #856404;
        }
        
        .compatibility-check i {
            margin-right: 8px;
        }
        
        .no-voice-support {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            .calendar-grid {
                gap: 5px;
            }
            
            .day {
                height: 85px;
                padding: 5px;
                font-size: 0.85rem;
            }
            
            .day-number {
                font-size: 1rem;
            }
            
            .indicator {
                width: 22px;
                height: 22px;
                font-size: 0.7rem;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .modal-content {
                width: 95%;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
                padding: 8px;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .mastered-item {
                padding: 10px;
            }
            
            .mastered-content {
                font-size: 1.2rem;
            }
            
            .mastered-details {
                flex-direction: column;
                gap: 5px;
            }
            
            .dictation-settings {
                grid-template-columns: 1fr;
            }
            
            .dictation-buttons {
                flex-direction: column;
            }
            
            .dictation-word {
                font-size: 1.5rem;
                min-height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-brain"></i> 艾宾浩斯日历</h1>
            <p class="subtitle">基于艾宾浩斯记忆曲线，自动生成第2、4、7、15天复习内容，帮助孩子高效消灭错别字。</p>
        </header>
        
        <!-- 状态栏 -->
        <div class="stats-container">
            <div class="stat-card stat-new">
                <div class="stat-value" id="today-new-count">0</div>
                <div class="stat-label">今日新增</div>
            </div>
            <div class="stat-card stat-review">
                <div class="stat-value" id="today-review-count">0</div>
                <div class="stat-label">今日需复习</div>
            </div>
            <div class="stat-card stat-mastered" id="mastered-card">
                <div class="stat-value" id="mastered-count">0</div>
                <div class="stat-label">已100%学会</div>
            </div>
        </div>
        
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-title" id="calendar-title">2023年12月</div>
                <div class="nav-buttons">
                    <button id="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <button id="next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            
            <div class="weekdays">
                <div>周日</div>
                <div>周一</div>
                <div>周二</div>
                <div>周三</div>
                <div>周四</div>
                <div>周五</div>
                <div>周六</div>
            </div>
            
            <div class="calendar-grid" id="calendar">
                <!-- 日历将由JavaScript生成 -->
            </div>
        </div>
    </div>
    
    <!-- 日期详情模态框 -->
    <div class="modal" id="day-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span id="modal-date-text">2023年12月11日</span>
                    <span class="modal-date-badge" id="modal-date-badge"></span>
                </div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="new">新增</div>
                    <div class="tab" data-tab="review">待复习 (<span id="review-count">0</span>)</div>
                    <div class="tab" data-tab="reviewed">已复习 (<span id="reviewed-count">0</span>)</div>
                </div>
                
                <!-- 新增内容标签页 -->
                <div class="tab-content active" id="new-content">
                    <div class="form-group">
                        <label for="content-input">输入需要消灭的错别字（用逗号分隔多个错别字）</label>
                        <textarea id="content-input" placeholder="例如：温暖,滴答,似乎,鼠标,good morning"></textarea>
                        <div class="input-hint">支持中文逗号、英文逗号分隔，空格不会作为分隔符</div>
                    </div>
                    
                    <button class="btn btn-primary btn-block" id="add-content">添加错别字</button>
                    
                    <div class="content-list" id="content-list">
                        <!-- 内容项将在这里添加 -->
                    </div>
                </div>
                
                <!-- 复习内容标签页 -->
                <div class="tab-content" id="review-content">
                    <!-- 听写控制面板 -->
                    <div id="dictation-container" style="display: none;">
                        <div class="dictation-controls">
                            <div class="dictation-header">
                                <div class="dictation-title">
                                    <i class="fas fa-volume-up"></i> 听写功能
                                </div>
                                <div class="dictation-status">
                                    <span id="dictation-status-text">待开始</span>
                                    <div class="status-indicator" id="status-indicator"></div>
                                </div>
                            </div>
                            
                            <!-- 兼容性检查 -->
                            <div id="compatibility-check" class="compatibility-check" style="display: none;">
                                <i class="fas fa-info-circle"></i>
                                <span>您的浏览器支持语音功能，可以开始听写</span>
                            </div>
                            
                            <div id="no-voice-support" class="no-voice-support" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>您的浏览器不支持语音功能，请使用Chrome、Safari或Edge浏览器</span>
                            </div>
                            
                            <div class="dictation-settings">
                                <div class="setting-group">
                                    <label class="setting-label">朗读间隔（秒）</label>
                                    <input type="range" id="interval-slider" min="1" max="5" step="0.5" value="2">
                                    <div class="setting-value"><span id="interval-value">2</span> 秒</div>
                                </div>
                                <div class="setting-group">
                                    <label class="setting-label">重复次数</label>
                                    <input type="range" id="repeat-slider" min="1" max="5" step="1" value="3">
                                    <div class="setting-value"><span id="repeat-value">3</span> 次</div>
                                </div>
                                <div class="setting-group">
                                    <label class="setting-label">朗读速度</label>
                                    <input type="range" id="speed-slider" min="0.5" max="1.5" step="0.1" value="0.9">
                                    <div class="setting-value"><span id="speed-value">0.9</span></div>
                                </div>
                            </div>
                            
                            <div class="dictation-buttons">
                                <button class="btn btn-start-dictation" id="start-dictation">
                                    <i class="fas fa-play"></i> 开始听写
                                </button>
                                <button class="btn btn-pause-dictation" id="pause-dictation" style="display: none;">
                                    <i class="fas fa-pause"></i> 暂停
                                </button>
                                <button class="btn btn-stop-dictation" id="stop-dictation" style="display: none;">
                                    <i class="fas fa-stop"></i> 停止
                                </button>
                            </div>
                            
                            <!-- 当前听写显示 -->
                            <div id="current-dictation" class="current-dictation" style="display: none;">
                                <div class="dictation-word" id="dictation-word">请准备听写...</div>
                                <div class="dictation-info">
                                    <div>进度: <span id="dictation-progress">0/0</span></div>
                                    <div>重复: <span id="dictation-repeat">0/0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="review-items">
                        <!-- 复习项将在这里添加 -->
                    </div>
                </div>
                
                <!-- 已复习内容标签页 -->
                <div class="tab-content" id="reviewed-content">
                    <div id="reviewed-items">
                        <!-- 已复习项将在这里添加 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 已学会内容模态框 -->
    <div class="modal" id="mastered-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-trophy"></i> 已100%学会的内容
                </div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mastered-items-container">
                    <!-- 已学会内容将在这里显示 -->
                </div>
                <div id="no-mastered-content" class="empty-state" style="display: none;">
                    <i class="fas fa-trophy"></i>
                    <p>还没有100%学会的内容</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">继续加油！通过复习可以提升记忆强度</p>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>关注小红书：塔塔自习室 版权所有 侵权必究</p>
    </footer>
    
    <script>
        // 当前日期
        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();
        
        // 月份名称
        const months = ["1月", "2月", "3月", "4月", "5月", "6月", 
                       "7月", "8月", "9月", "10月", "11月", "12月"];
        
        // 复习周期 (第2、4、7、15天，今天输入算第1天)
        const reviewIntervals = [2, 4, 7, 15];
        
        // 学习数据存储
        let learningData = JSON.parse(localStorage.getItem('learningData')) || {};
        
        // 当前查看的日期
        let currentViewDate = null;
        
        // 听写相关变量
        let dictationActive = false;
        let dictationPaused = false;
        let dictationQueue = [];
        let currentDictationIndex = 0;
        let currentRepeatCount = 0;
        let speechSynthesis = window.speechSynthesis;
        let isVoiceSupported = false;
        let dictationSettings = {
            interval: 2, // 间隔时间（秒）
            repeat: 3,   // 重复次数
            speed: 0.9   // 朗读速度
        };
        let dictationTimeout = null;
        
        // 检查语音支持
        function checkVoiceSupport() {
            isVoiceSupported = 'speechSynthesis' in window;
            
            const compatibilityCheck = document.getElementById('compatibility-check');
            const noVoiceSupport = document.getElementById('no-voice-support');
            const dictationContainer = document.getElementById('dictation-container');
            
            if (isVoiceSupported) {
                compatibilityCheck.style.display = 'block';
                noVoiceSupport.style.display = 'none';
            } else {
                compatibilityCheck.style.display = 'none';
                noVoiceSupport.style.display = 'block';
            }
            
            // 只有在有复习内容时才显示听写容器
            const reviewCount = document.getElementById('review-count').textContent;
            if (parseInt(reviewCount) > 0 && isVoiceSupported) {
                dictationContainer.style.display = 'block';
            } else {
                dictationContainer.style.display = 'none';
            }
        }
        
        // 数据迁移：确保日期键格式统一
        function migrateData() {
            const migratedData = {};
            let hasChanges = false;
            
            for (const [dateStr, data] of Object.entries(learningData)) {
                // 检查日期格式是否为YYYY-M-D或YYYY-MM-DD
                const dateParts = dateStr.split('-');
                if (dateParts.length === 3) {
                    let year = dateParts[0];
                    let month = dateParts[1];
                    let day = dateParts[2];
                    
                    // 确保月份和日期是两位数
                    if (month.length === 1) {
                        month = month.padStart(2, '0');
                        hasChanges = true;
                    }
                    if (day.length === 1) {
                        day = day.padStart(2, '0');
                        hasChanges = true;
                    }
                    
                    const newDateStr = `${year}-${month}-${day}`;
                    migratedData[newDateStr] = data;
                    
                    // 如果日期格式有变化，记录迁移
                    if (newDateStr !== dateStr) {
                        hasChanges = true;
                    }
                } else {
                    // 如果格式不正确，保留原数据
                    migratedData[dateStr] = data;
                }
            }
            
            if (hasChanges) {
                learningData = migratedData;
                saveData();
                console.log('数据迁移完成');
            }
        }
        
        // 执行数据迁移
        migrateData();
        
        // 初始化日历
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';
            
            // 设置标题
            document.getElementById('calendar-title').textContent = 
                `${currentYear}年${months[currentMonth]}`;
            
            // 获取当月第一天和最后一天
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            
            // 获取第一天是星期几 (0 = 周日, 6 = 周六)
            const firstDayIndex = firstDay.getDay();
            
            // 获取最后一天是几号
            const lastDate = lastDay.getDate();
            
            // 获取上个月最后一天
            const prevLastDay = new Date(currentYear, currentMonth, 0);
            const prevLastDate = prevLastDay.getDate();
            
            // 下个月开始几天
            const nextDays = 7 - lastDay.getDay() - 1;
            
            // 生成日历格子
            let days = "";
            
            // 上个月的日期
            for (let i = firstDayIndex; i > 0; i--) {
                days += `<div class="day other-month">${prevLastDate - i + 1}</div>`;
            }
            
            // 本月的日期
            for (let i = 1; i <= lastDate; i++) {
                const isToday = i === today.getDate() && 
                               currentMonth === today.getMonth() && 
                               currentYear === today.getFullYear();
                
                // 确保日期格式为YYYY-MM-DD
                const monthStr = (currentMonth + 1).toString().padStart(2, '0');
                const dayStr = i.toString().padStart(2, '0');
                const dateStr = `${currentYear}-${monthStr}-${dayStr}`;
                
                // 计算该日期的新增、待复习和已复习数量
                const counts = calculateDayCounts(dateStr);
                const newCount = counts.newCount;
                const needReviewCount = counts.needReviewCount;
                const reviewedCount = counts.reviewedCount;
                
                // 生成指示器
                let indicatorsHtml = '';
                if (newCount > 0) {
                    indicatorsHtml += `<div class="indicator indicator-blue">${newCount}</div>`;
                }
                if (needReviewCount > 0) {
                    indicatorsHtml += `<div class="indicator indicator-yellow">${needReviewCount}</div>`;
                }
                if (reviewedCount > 0) {
                    indicatorsHtml += `<div class="indicator indicator-red">${reviewedCount}</div>`;
                }
                
                let dayClass = 'day';
                if (isToday) dayClass += ' today';
                
                days += `
                    <div class="${dayClass}" data-date="${dateStr}">
                        <div class="day-number">${i}</div>
                        <div class="day-indicators">${indicatorsHtml}</div>
                    </div>
                `;
            }
            
            // 下个月的日期
            for (let i = 1; i <= nextDays; i++) {
                days += `<div class="day other-month">${i}</div>`;
            }
            
            calendarEl.innerHTML = days;
            
            // 添加日期点击事件
            document.querySelectorAll('.day:not(.other-month)').forEach(day => {
                day.addEventListener('click', () => {
                    const dateStr = day.getAttribute('data-date');
                    openDayModal(dateStr);
                });
            });
            
            // 更新统计信息
            updateStats();
        }
        
        // 计算某天的新增、待复习和已复习数量
        function calculateDayCounts(dateStr) {
            // 标准化日期字符串
            const normalizedDateStr = normalizeDateStr(dateStr);
            
            let newCount = 0;
            let needReviewCount = 0;
            let reviewedCount = 0;
            
            // 1. 计算新增内容数量
            // 直接检查是否有该日期的学习记录
            if (learningData[normalizedDateStr] && learningData[normalizedDateStr].contents) {
                newCount = learningData[normalizedDateStr].contents.length;
            }
            
            // 2. 计算需要复习和已复习的数量
            const currentDate = parseDateStr(normalizedDateStr);
            
            // 遍历所有学习记录
            for (const [learnDateStr, data] of Object.entries(learningData)) {
                if (data.contents && data.contents.length > 0) {
                    const learnDate = parseDateStr(learnDateStr);
                    
                    // 计算天数差 (从学习日算起，学习日算第1天)
                    const diffTime = currentDate - learnDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    // 检查是否在复习周期内
                    if (reviewIntervals.includes(diffDays)) {
                        // 检查每个内容是否需要复习
                        data.contents.forEach((content, index) => {
                            // 获取该内容的复习记录
                            const reviews = data.reviews && data.reviews[index] ? data.reviews[index] : [];
                            
                            // 检查是否已经在这一天复习过
                            const alreadyReviewed = reviews.some(r => {
                                if (!r.date) return false;
                                const reviewDate = parseDateStr(r.date);
                                return reviewDate.getTime() === currentDate.getTime();
                            });
                            
                            if (alreadyReviewed) {
                                reviewedCount++;
                            } else {
                                needReviewCount++;
                            }
                        });
                    }
                }
            }
            
            return { newCount, needReviewCount, reviewedCount };
        }
        
        // 标准化日期字符串为YYYY-MM-DD格式
        function normalizeDateStr(dateStr) {
            if (!dateStr) return '';
            
            const dateParts = dateStr.split('-');
            if (dateParts.length !== 3) return dateStr;
            
            const year = dateParts[0];
            const month = dateParts[1].padStart(2, '0');
            const day = dateParts[2].padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }
        
        // 解析日期字符串为Date对象
        function parseDateStr(dateStr) {
            const normalizedStr = normalizeDateStr(dateStr);
            const parts = normalizedStr.split('-').map(Number);
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }
        
        // 更新统计信息
        function updateStats() {
            // 计算今日新增
            const todayStr = normalizeDateStr(`${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`);
            const todayNewCount = learningData[todayStr] && learningData[todayStr].contents ? 
                                 learningData[todayStr].contents.length : 0;
            
            // 计算今日需复习和已复习
            const todayCounts = calculateDayCounts(todayStr);
            const todayReviewCount = todayCounts.needReviewCount;
            
            // 计算已100%学会的词组
            let masteredCount = 0;
            for (const [dateStr, data] of Object.entries(learningData)) {
                if (data.contents && data.contents.length > 0) {
                    data.contents.forEach((content, index) => {
                        if (isContentMastered(dateStr, index)) {
                            masteredCount++;
                        }
                    });
                }
            }
            
            // 更新显示
            document.getElementById('today-new-count').textContent = todayNewCount;
            document.getElementById('today-review-count').textContent = todayReviewCount;
            document.getElementById('mastered-count').textContent = masteredCount;
        }
        
        // 检查内容是否已完全掌握（达到100%）
        function isContentMastered(dateStr, index) {
            if (!learningData[dateStr] || !learningData[dateStr].reviews || 
                !learningData[dateStr].reviews[index]) {
                return false;
            }
            
            const reviews = learningData[dateStr].reviews[index];
            
            // 检查是否完成了所有复习周期并且每次都是正确的
            let completedCorrectCount = 0;
            for (const interval of reviewIntervals) {
                const hasCorrectReview = reviews.some(r => r.reviewDay === interval && r.result === 'correct');
                if (hasCorrectReview) {
                    completedCorrectCount++;
                }
            }
            
            // 如果完成了所有4次复习，且每次都是正确的，则达到100%
            return completedCorrectCount === reviewIntervals.length;
        }
        
        // 获取所有已学会的内容
        function getAllMasteredContents() {
            const masteredContents = [];
            
            // 遍历所有学习记录
            for (const [dateStr, data] of Object.entries(learningData)) {
                if (data.contents && data.contents.length > 0) {
                    data.contents.forEach((content, index) => {
                        if (isContentMastered(dateStr, index)) {
                            // 获取该内容的复习记录
                            const reviews = data.reviews && data.reviews[index] ? data.reviews[index] : [];
                            
                            // 获取最后一次复习的日期
                            let lastReviewDate = null;
                            if (reviews.length > 0) {
                                const sortedReviews = [...reviews].sort((a, b) => {
                                    if (!a.date || !b.date) return 0;
                                    return parseDateStr(b.date) - parseDateStr(a.date);
                                });
                                lastReviewDate = sortedReviews[0].date;
                            }
                            
                            masteredContents.push({
                                content: content,
                                learnDate: dateStr,
                                lastReviewDate: lastReviewDate,
                                reviews: reviews
                            });
                        }
                    });
                }
            }
            
            // 按最后复习日期排序（最新的在前）
            masteredContents.sort((a, b) => {
                if (!a.lastReviewDate || !b.lastReviewDate) return 0;
                return parseDateStr(b.lastReviewDate) - parseDateStr(a.lastReviewDate);
            });
            
            return masteredContents;
        }
        
        // 显示已学会内容模态框
        function showMasteredModal() {
            const modal = document.getElementById('mastered-modal');
            const masteredItemsContainer = document.getElementById('mastered-items-container');
            const noMasteredContent = document.getElementById('no-mastered-content');
            
            // 获取所有已学会的内容
            const masteredContents = getAllMasteredContents();
            
            if (masteredContents.length > 0) {
                // 显示已学会的内容
                let masteredHtml = '';
                
                masteredContents.forEach((item, index) => {
                    // 计算掌握天数（从学习日期到最后一次复习日期）
                    let masteryDays = 0;
                    if (item.lastReviewDate) {
                        const learnDate = parseDateStr(item.learnDate);
                        const lastReviewDate = parseDateStr(item.lastReviewDate);
                        const diffTime = lastReviewDate - learnDate;
                        masteryDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    }
                    
                    // 统计正确复习次数
                    const correctReviews = item.reviews.filter(r => r.result === 'correct').length;
                    
                    masteredHtml += `
                        <div class="mastered-item">
                            <div class="mastered-header">
                                <div><strong>#${index + 1}</strong> <span class="mastered-badge">100% 掌握</span></div>
                                <div>学习于: ${item.learnDate}</div>
                            </div>
                            <div class="mastered-content">
                                <span>${item.content}</span>
                            </div>
                            <div class="mastered-details">
                                <div>掌握用时: ${masteryDays} 天</div>
                                <div>正确复习: ${correctReviews} 次</div>
                            </div>
                            <div class="mastered-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 100%"></div>
                                </div>
                                <div class="progress-text">记忆强度: 100%</div>
                            </div>
                        </div>
                    `;
                });
                
                masteredItemsContainer.innerHTML = masteredHtml;
                masteredItemsContainer.style.display = 'block';
                noMasteredContent.style.display = 'none';
            } else {
                masteredItemsContainer.style.display = 'none';
                noMasteredContent.style.display = 'block';
            }
            
            modal.style.display = 'flex';
        }
        
        // 打开日期详情模态框
        function openDayModal(dateStr) {
            currentViewDate = normalizeDateStr(dateStr);
            const modal = document.getElementById('day-modal');
            const [year, month, day] = currentViewDate.split('-').map(Number);
            
            document.getElementById('modal-date-text').textContent = `${year}年${month}月${day}日`;
            
            // 设置日期徽章
            const dateObj = new Date(year, month - 1, day);
            const options = { weekday: 'long' };
            const weekday = dateObj.toLocaleDateString('zh-CN', options);
            document.getElementById('modal-date-badge').textContent = weekday;
            
            // 计算该日期的复习数量
            const counts = calculateDayCounts(currentViewDate);
            const reviewCount = counts.needReviewCount;
            const reviewedCount = counts.reviewedCount;
            document.getElementById('review-count').textContent = reviewCount;
            document.getElementById('reviewed-count').textContent = reviewedCount;
            
            // 更新内容列表
            updateContentList(currentViewDate);
            
            // 显示复习内容
            updateReviewTab(currentViewDate);
            
            // 显示已复习内容
            updateReviewedTab(currentViewDate);
            
            // 设置添加内容按钮事件
            document.getElementById('add-content').onclick = function() {
                addContent(currentViewDate);
            };
            
            // 允许按Enter键添加内容
            document.getElementById('content-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addContent(currentViewDate);
                }
            });
            
            modal.style.display = 'flex';
            
            // 添加关闭模态框事件
            document.querySelector('.close-modal').addEventListener('click', closeModal);
            
            // 检查语音支持
            checkVoiceSupport();
            
            // 初始化听写设置滑块
            initDictationControls();
            
            // 停止所有可能的听写
            stopDictation();
        }
        
        // 初始化听写控制
        function initDictationControls() {
            // 设置滑块值
            document.getElementById('interval-slider').value = dictationSettings.interval;
            document.getElementById('repeat-slider').value = dictationSettings.repeat;
            document.getElementById('speed-slider').value = dictationSettings.speed;
            
            // 更新显示值
            updateDictationValue('interval-value', dictationSettings.interval);
            updateDictationValue('repeat-value', dictationSettings.repeat);
            updateDictationValue('speed-value', dictationSettings.speed);
            
            // 绑定滑块事件
            document.getElementById('interval-slider').addEventListener('input', function() {
                dictationSettings.interval = parseFloat(this.value);
                updateDictationValue('interval-value', dictationSettings.interval);
            });
            
            document.getElementById('repeat-slider').addEventListener('input', function() {
                dictationSettings.repeat = parseInt(this.value);
                updateDictationValue('repeat-value', dictationSettings.repeat);
            });
            
            document.getElementById('speed-slider').addEventListener('input', function() {
                dictationSettings.speed = parseFloat(this.value);
                updateDictationValue('speed-value', dictationSettings.speed);
            });
            
            // 绑定听写按钮事件
            document.getElementById('start-dictation').addEventListener('click', startDictation);
            document.getElementById('pause-dictation').addEventListener('click', togglePauseDictation);
            document.getElementById('stop-dictation').addEventListener('click', stopDictation);
        }
        
        // 更新听写设置显示值
        function updateDictationValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            }
        }
        
        // 获取需要听写的内容列表
        function getDictationContent() {
            const [year, month, day] = currentViewDate.split('-').map(Number);
            const currentDate = new Date(year, month - 1, day);
            const dictationContent = [];
            
            // 查找所有需要在这一天复习的内容
            for (const [learnDateStr, data] of Object.entries(learningData)) {
                if (data.contents && data.contents.length > 0) {
                    const learnDate = parseDateStr(learnDateStr);
                    
                    // 计算天数差 (从学习日算起，学习日算第1天)
                    const diffTime = currentDate - learnDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    // 检查是否在复习周期内
                    if (reviewIntervals.includes(diffDays)) {
                        // 检查每个内容是否需要复习
                        data.contents.forEach((content, index) => {
                            // 获取该内容的复习记录
                            const reviews = data.reviews && data.reviews[index] ? data.reviews[index] : [];
                            
                            // 检查是否已经在这一天复习过
                            const alreadyReviewed = reviews.some(r => {
                                if (!r.date) return false;
                                const reviewDate = parseDateStr(r.date);
                                return reviewDate.getTime() === currentDate.getTime();
                            });
                            
                            if (!alreadyReviewed) {
                                dictationContent.push({
                                    content: content,
                                    learnDate: learnDateStr,
                                    index: index,
                                    reviewDay: diffDays
                                });
                            }
                        });
                    }
                }
            }
            
            return dictationContent;
        }
        
        // 开始听写
        function startDictation() {
            if (!isVoiceSupported) {
                alert('您的浏览器不支持语音功能，请使用Chrome、Safari或Edge浏览器');
                return;
            }
            
            // 获取听写内容
            dictationQueue = getDictationContent();
            
            if (dictationQueue.length === 0) {
                alert('没有需要听写的内容');
                return;
            }
            
            // 重置状态
            currentDictationIndex = 0;
            currentRepeatCount = 0;
            dictationActive = true;
            dictationPaused = false;
            
            // 更新UI
            updateDictationUI();
            
            // 开始听写
            startDictationPrompt();
        }
        
        // 开始听写提示
        function startDictationPrompt() {
            // 显示准备状态
            document.getElementById('dictation-word').textContent = '请准备听写...';
            document.getElementById('dictation-progress').textContent = `0/${dictationQueue.length}`;
            document.getElementById('dictation-repeat').textContent = `0/${dictationSettings.repeat}`;
            
            // 播报"开始听写"
            speakText('开始听写', false);
            
            // 等待1.5秒后开始第一个词语
            setTimeout(() => {
                if (dictationActive && !dictationPaused) {
                    speakNextWord();
                }
            }, 1500);
        }
        
        // 播放下一个词语
        function speakNextWord() {
            if (!dictationActive || dictationPaused) return;
            
            // 检查是否完成所有词语
            if (currentDictationIndex >= dictationQueue.length) {
                // 完成所有词语，结束听写
                completeDictation();
                return;
            }
            
            const currentItem = dictationQueue[currentDictationIndex];
            
            // 播报当前词语（不显示在屏幕上）
            speakText(currentItem.content, true);
            
            // 更新进度显示（不显示具体词语）
            document.getElementById('dictation-word').textContent = '请听写';
            document.getElementById('dictation-progress').textContent = `${currentDictationIndex + 1}/${dictationQueue.length}`;
            document.getElementById('dictation-repeat').textContent = `${currentRepeatCount + 1}/${dictationSettings.repeat}`;
            
            // 更新重复计数
            currentRepeatCount++;
            
            // 如果达到重复次数，移动到下一个词语
            if (currentRepeatCount >= dictationSettings.repeat) {
                currentDictationIndex++;
                currentRepeatCount = 0;
                
                // 延迟播放下一个词语
                if (currentDictationIndex < dictationQueue.length) {
                    clearTimeout(dictationTimeout);
                    dictationTimeout = setTimeout(() => {
                        speakNextWord();
                    }, dictationSettings.interval * 1000);
                } else {
                    // 所有词语都播报完了
                    setTimeout(() => {
                        completeDictation();
                    }, dictationSettings.interval * 1000);
                }
            } else {
                // 继续重复当前词语
                clearTimeout(dictationTimeout);
                dictationTimeout = setTimeout(() => {
                    speakNextWord();
                }, dictationSettings.interval * 1000);
            }
        }
        
        // 朗读文本
        function speakText(text, updateStatus = true) {
            if (!isVoiceSupported) return;
            
            // 停止当前语音
            speechSynthesis.cancel();
            
            // 创建语音实例
            const utterance = new SpeechSynthesisUtterance(text);
            
            // 设置语音参数
            utterance.lang = 'zh-CN';
            utterance.rate = dictationSettings.speed;
            utterance.volume = 1;
            
            // 开始朗读
            speechSynthesis.speak(utterance);
            
            if (updateStatus) {
                // 更新状态
                document.getElementById('dictation-status-text').textContent = '朗读中';
                document.getElementById('status-indicator').classList.add('active');
            }
            
            // 语音结束事件
            utterance.onend = function() {
                if (updateStatus) {
                    document.getElementById('dictation-status-text').textContent = '进行中';
                }
            };
        }
        
        // 更新听写UI
        function updateDictationUI() {
            // 显示听写控制区域
            document.getElementById('current-dictation').style.display = 'block';
            
            // 切换按钮显示
            document.getElementById('start-dictation').style.display = 'none';
            document.getElementById('pause-dictation').style.display = 'block';
            document.getElementById('stop-dictation').style.display = 'block';
            
            // 更新状态指示器
            document.getElementById('status-indicator').classList.add('active');
            document.getElementById('dictation-status-text').textContent = '进行中';
        }
        
        // 切换暂停/继续听写
        function togglePauseDictation() {
            if (!dictationActive) return;
            
            dictationPaused = !dictationPaused;
            
            if (dictationPaused) {
                // 暂停语音
                speechSynthesis.pause();
                clearTimeout(dictationTimeout);
                document.getElementById('pause-dictation').innerHTML = '<i class="fas fa-play"></i> 继续';
                document.getElementById('dictation-status-text').textContent = '已暂停';
                document.getElementById('status-indicator').classList.remove('active');
            } else {
                // 继续语音
                speechSynthesis.resume();
                document.getElementById('pause-dictation').innerHTML = '<i class="fas fa-pause"></i> 暂停';
                document.getElementById('dictation-status-text').textContent = '进行中';
                document.getElementById('status-indicator').classList.add('active');
                
                // 如果当前没有在朗读，重新开始
                if (!speechSynthesis.speaking) {
                    speakNextWord();
                }
            }
        }
        
        // 停止听写
        function stopDictation() {
            dictationActive = false;
            dictationPaused = false;
            
            // 停止语音
            speechSynthesis.cancel();
            clearTimeout(dictationTimeout);
            
            // 重置UI
            document.getElementById('current-dictation').style.display = 'none';
            document.getElementById('start-dictation').style.display = 'block';
            document.getElementById('pause-dictation').style.display = 'none';
            document.getElementById('stop-dictation').style.display = 'none';
            
            // 重置状态指示器
            document.getElementById('status-indicator').classList.remove('active');
            document.getElementById('dictation-status-text').textContent = '待开始';
        }
        
        // 完成听写
        function completeDictation() {
            // 播报完成提示
            speakText('此次听写完毕', false);
            
            // 显示完成消息
            document.getElementById('dictation-word').textContent = '听写完成';
            document.getElementById('dictation-status-text').textContent = '已完成';
            
            // 重置状态，但保持显示完成状态
            dictationActive = false;
            dictationPaused = false;
            
            // 1秒后重置按钮
            setTimeout(() => {
                document.getElementById('start-dictation').style.display = 'block';
                document.getElementById('pause-dictation').style.display = 'none';
                document.getElementById('stop-dictation').style.display = 'none';
                document.getElementById('status-indicator').classList.remove('active');
            }, 1000);
        }
        
        // 更新复习标签页
        function updateReviewTab(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const reviewItems = document.getElementById('review-items');
            reviewItems.innerHTML = '';
            
            // 计算复习数量
            const counts = calculateDayCounts(dateStr);
            const reviewCount = counts.needReviewCount;
            
            // 更新听写容器显示
            const dictationContainer = document.getElementById('dictation-container');
            if (reviewCount > 0 && isVoiceSupported) {
                dictationContainer.style.display = 'block';
            } else {
                dictationContainer.style.display = 'none';
            }
            
            if (reviewCount > 0) {
                let reviewItemsCount = 0;
                
                // 查找所有需要在这一天复习的内容
                for (const [learnDateStr, data] of Object.entries(learningData)) {
                    if (data.contents && data.contents.length > 0) {
                        const learnDate = parseDateStr(learnDateStr);
                        const currentDate = new Date(year, month - 1, day);
                        
                        // 计算天数差 (从学习日算起，学习日算第1天)
                        const diffTime = currentDate - learnDate;
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                        
                        // 检查是否在复习周期内
                        if (reviewIntervals.includes(diffDays)) {
                            // 为每个内容创建复习项
                            data.contents.forEach((content, index) => {
                                // 获取该内容的复习记录
                                const reviews = data.reviews && data.reviews[index] ? data.reviews[index] : [];
                                
                                // 检查是否已经在这一天复习过
                                const alreadyReviewed = reviews.some(r => {
                                    if (!r.date) return false;
                                    const reviewDate = parseDateStr(r.date);
                                    return reviewDate.getTime() === currentDate.getTime();
                                });
                                
                                if (!alreadyReviewed) {
                                    reviewItemsCount++;
                                    // 计算该内容的当前进度
                                    const progress = calculateContentProgress(learnDateStr, index);
                                    
                                    const reviewItem = document.createElement('div');
                                    reviewItem.className = 'review-item need-review';
                                    reviewItem.innerHTML = `
                                        <div class="review-header">
                                            <div><strong>复习 #${reviewItemsCount}</strong> <span class="review-type">第${diffDays}天复习</span></div>
                                            <div>学习于: ${learnDateStr}</div>
                                        </div>
                                        <div class="review-content">
                                            <span>${content}</span>
                                        </div>
                                        <div class="review-stats">
                                            <div>当前记忆强度: <span class="stat-correct">${progress}%</span></div>
                                            <div>本次复习正确可增加: <span class="stat-correct">25%</span></div>
                                        </div>
                                        <div class="review-actions">
                                            <button class="btn btn-success" data-date="${learnDateStr}" data-index="${index}" data-day="${diffDays}" data-result="correct">已记住</button>
                                            <button class="btn btn-danger" data-date="${learnDateStr}" data-index="${index}" data-day="${diffDays}" data-result="wrong">忘记</button>
                                        </div>
                                        <div class="history-list" id="history-${learnDateStr}-${index}">
                                            ${getReviewHistory(learnDateStr, index)}
                                        </div>
                                    `;
                                    reviewItems.appendChild(reviewItem);
                                    
                                    // 添加复习按钮事件
                                    const successBtn = reviewItem.querySelector('.btn-success');
                                    const dangerBtn = reviewItem.querySelector('.btn-danger');
                                    
                                    if (successBtn && dangerBtn) {
                                        successBtn.addEventListener('click', handleReview);
                                        dangerBtn.addEventListener('click', handleReview);
                                    }
                                }
                            });
                        }
                    }
                }
            } else {
                reviewItems.innerHTML = '<div class="no-content">今天没有需要复习的错别字</div>';
            }
        }
        
        // 更新已复习标签页
        function updateReviewedTab(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const reviewedItems = document.getElementById('reviewed-items');
            reviewedItems.innerHTML = '';
            
            // 计算已复习数量
            const counts = calculateDayCounts(dateStr);
            const reviewedCount = counts.reviewedCount;
            
            if (reviewedCount > 0) {
                let reviewedItemsCount = 0;
                
                // 查找所有在这一天已经复习过的内容
                for (const [learnDateStr, data] of Object.entries(learningData)) {
                    if (data.contents && data.contents.length > 0) {
                        const learnDate = parseDateStr(learnDateStr);
                        const currentDate = new Date(year, month - 1, day);
                        
                        // 计算天数差 (从学习日算起，学习日算第1天)
                        const diffTime = currentDate - learnDate;
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                        
                        // 检查是否在复习周期内
                        if (reviewIntervals.includes(diffDays)) {
                            // 检查每个内容是否已经在这一天复习过
                            data.contents.forEach((content, index) => {
                                // 获取该内容的复习记录
                                const reviews = data.reviews && data.reviews[index] ? data.reviews[index] : [];
                                
                                // 检查是否已经在这一天复习过
                                const todayReview = reviews.find(r => {
                                    if (!r.date) return false;
                                    const reviewDate = parseDateStr(r.date);
                                    return reviewDate.getTime() === currentDate.getTime();
                                });
                                
                                if (todayReview) {
                                    reviewedItemsCount++;
                                    // 计算该内容的当前进度
                                    const progress = calculateContentProgress(learnDateStr, index);
                                    const oldProgress = progress - (todayReview.result === 'correct' ? 25 : 0);
                                    
                                    const reviewedItem = document.createElement('div');
                                    reviewedItem.className = 'reviewed-item';
                                    reviewedItem.innerHTML = `
                                        <div class="reviewed-header">
                                            <div><strong>已复习 #${reviewedItemsCount}</strong> <span class="review-type">第${diffDays}天复习</span></div>
                                            <div>学习于: ${learnDateStr}</div>
                                        </div>
                                        <div class="reviewed-content">
                                            <span>${content}</span>
                                        </div>
                                        <div class="reviewed-result">
                                            <div>复习结果: <span class="${todayReview.result === 'correct' ? 'reviewed-correct' : 'reviewed-wrong'}">${todayReview.result === 'correct' ? '✓ 正确' : '✗ 错误'}</span></div>
                                            <div>记忆强度变化: <span class="${todayReview.result === 'correct' ? 'reviewed-correct' : 'reviewed-wrong'}">${todayReview.result === 'correct' ? '+25%' : '+0%'}</span></div>
                                        </div>
                                        <div class="reviewed-progress">
                                            <div>复习前记忆强度: ${oldProgress}% → 当前记忆强度: ${progress}%</div>
                                        </div>
                                        <div class="history-list" id="reviewed-history-${learnDateStr}-${index}">
                                            ${getReviewHistory(learnDateStr, index)}
                                        </div>
                                    `;
                                    reviewedItems.appendChild(reviewedItem);
                                }
                            });
                        }
                    }
                }
            } else {
                reviewedItems.innerHTML = '<div class="no-content">今天没有已复习的错别字</div>';
            }
        }
        
        // 计算内容进度
        function calculateContentProgress(dateStr, index) {
            if (!learningData[dateStr] || !learningData[dateStr].reviews || 
                !learningData[dateStr].reviews[index]) {
                return 0;
            }
            
            const reviews = learningData[dateStr].reviews[index];
            
            // 计算正确复习的次数
            let correctCount = 0;
            reviews.forEach(review => {
                if (review.result === 'correct') {
                    correctCount++;
                }
            });
            
            // 每次正确复习增加25%进度
            return Math.min(100, correctCount * 25);
        }
        
        // 获取复习历史
        function getReviewHistory(dateStr, index) {
            if (!learningData[dateStr] || !learningData[dateStr].reviews || 
                !learningData[dateStr].reviews[index]) {
                return '<div class="history-item">暂无复习记录</div>';
            }
            
            let historyHtml = '';
            const reviews = learningData[dateStr].reviews[index];
            
            // 按复习天数排序，确保显示顺序正确
            const sortedReviews = [...reviews].sort((a, b) => a.reviewDay - b.reviewDay);
            
            sortedReviews.forEach(review => {
                if (!review.date || !review.reviewDay) {
                    return;
                }
                
                const result = review.result === 'correct' ? 
                    '<span class="stat-correct">正确</span>' : 
                    '<span class="stat-wrong">错误</span>';
                
                // 显示复习日期
                const reviewDateStr = review.date;
                
                historyHtml += `<div class="history-item">${reviewDateStr} 第${review.reviewDay}天复习: ${result}</div>`;
            });
            
            return historyHtml || '<div class="history-item">暂无复习记录</div>';
        }
        
        // 处理复习结果
        function handleReview() {
            const learnDateStr = this.getAttribute('data-date');
            const index = parseInt(this.getAttribute('data-index'));
            const reviewDay = parseInt(this.getAttribute('data-day'));
            const result = this.getAttribute('data-result');
            
            // 确保日期格式标准化
            const normalizedLearnDateStr = normalizeDateStr(learnDateStr);
            
            // 初始化复习记录
            if (!learningData[normalizedLearnDateStr]) {
                learningData[normalizedLearnDateStr] = { contents: [], reviews: {} };
            }
            
            if (!learningData[normalizedLearnDateStr].reviews) {
                learningData[normalizedLearnDateStr].reviews = {};
            }
            
            if (!learningData[normalizedLearnDateStr].reviews[index]) {
                learningData[normalizedLearnDateStr].reviews[index] = [];
            }
            
            // 添加复习记录
            learningData[normalizedLearnDateStr].reviews[index].push({
                date: currentViewDate,
                reviewDay: reviewDay,
                result: result
            });
            
            // 保存数据
            saveData();
            
            // 禁用按钮
            this.disabled = true;
            const otherBtn = this.parentElement.querySelector(`button:not([data-result="${result}"])`);
            if (otherBtn) otherBtn.disabled = true;
            
            // 显示反馈信息
            const progress = calculateContentProgress(normalizedLearnDateStr, index);
            
            const feedback = document.createElement('div');
            feedback.className = result === 'correct' ? 'review-feedback correct' : 'review-feedback wrong';
            
            if (result === 'correct') {
                feedback.textContent = `✓ 已记住！记忆强度增加25%！当前记忆强度为${progress}%`;
            } else {
                feedback.textContent = `✗ 已忘记！记忆强度不变。当前记忆强度为${progress}%`;
            }
            
            this.closest('.review-item').appendChild(feedback);
            
            // 更新日历和统计
            initCalendar();
            
            // 重新计算当前日期的复习数量
            const counts = calculateDayCounts(currentViewDate);
            const reviewCount = counts.needReviewCount;
            const reviewedCount = counts.reviewedCount;
            
            // 更新标签计数
            document.getElementById('review-count').textContent = reviewCount;
            document.getElementById('reviewed-count').textContent = reviewedCount;
            
            // 如果复习数量为0，显示提示信息
            if (reviewCount === 0) {
                document.getElementById('review-items').innerHTML = '<div class="no-content">今天没有需要复习的错别字</div>';
                document.getElementById('dictation-container').style.display = 'none';
            }
            
            // 更新已复习标签页
            updateReviewedTab(currentViewDate);
            
            // 保存数据
            saveData();
        }
        
        // 添加学习内容
        function addContent(dateStr) {
            const contentInput = document.getElementById('content-input');
            const contentText = contentInput.value.trim();
            
            if (contentText) {
                // 使用正则表达式分割：只支持中文逗号和英文逗号，空格不作为分隔符
                const contents = contentText.split(/[，,]/).filter(item => item.trim() !== '');
                
                if (contents.length === 0) {
                    alert('请输入需要消灭的错别字');
                    return;
                }
                
                // 确保日期格式标准化
                const normalizedDateStr = normalizeDateStr(dateStr);
                
                // 初始化日期数据
                if (!learningData[normalizedDateStr]) {
                    learningData[normalizedDateStr] = {
                        contents: [],
                        reviews: {}
                    };
                }
                
                // 添加内容（按字母顺序排序）
                const newContents = [...contents].sort((a, b) => a.localeCompare(b, 'zh-CN'));
                learningData[normalizedDateStr].contents.push(...newContents);
                
                // 清空输入框
                contentInput.value = '';
                
                // 更新内容列表
                updateContentList(normalizedDateStr);
                
                // 更新日历显示和统计
                initCalendar();
                
                // 保存数据
                saveData();
            } else {
                alert('请输入需要消灭的错别字');
            }
        }
        
        // 删除学习内容
        function deleteContent(dateStr, index, confirm = false) {
            if (!confirm) {
                // 第一步：显示确认选项
                const confirmArea = document.getElementById(`confirm-${dateStr}-${index}`);
                if (confirmArea) {
                    confirmArea.classList.add('show');
                }
                return;
            }
            
            // 确保日期格式标准化
            const normalizedDateStr = normalizeDateStr(dateStr);
            
            // 第二步：执行删除
            learningData[normalizedDateStr].contents.splice(index, 1);
            
            // 如果还有对应的复习记录，也删除
            if (learningData[normalizedDateStr].reviews && learningData[normalizedDateStr].reviews[index]) {
                delete learningData[normalizedDateStr].reviews[index];
            }
            
            // 重新整理复习记录的索引（确保索引连续）
            const newReviews = {};
            if (learningData[normalizedDateStr].reviews) {
                Object.keys(learningData[normalizedDateStr].reviews).forEach((key, newIndex) => {
                    newReviews[newIndex] = learningData[normalizedDateStr].reviews[key];
                });
                learningData[normalizedDateStr].reviews = newReviews;
            }
            
            // 更新内容列表
            updateContentList(normalizedDateStr);
            
            // 更新日历显示
            initCalendar();
            
            // 保存数据
            saveData();
        }
        
        // 取消删除
        function cancelDelete(dateStr, index) {
            const confirmArea = document.getElementById(`confirm-${dateStr}-${index}`);
            if (confirmArea) {
                confirmArea.classList.remove('show');
            }
        }
        
        // 更新内容列表
        function updateContentList(dateStr) {
            const contentList = document.getElementById('content-list');
            contentList.innerHTML = '';
            
            // 确保日期格式标准化
            const normalizedDateStr = normalizeDateStr(dateStr);
            
            if (learningData[normalizedDateStr] && learningData[normalizedDateStr].contents.length > 0) {
                // 对内容进行排序
                const sortedContents = [...learningData[normalizedDateStr].contents].sort((a, b) => a.localeCompare(b, 'zh-CN'));
                
                sortedContents.forEach((content, index) => {
                    // 创建包装器
                    const wrapper = document.createElement('div');
                    wrapper.className = 'content-item-wrapper';
                    wrapper.id = `wrapper-${normalizedDateStr}-${index}`;
                    
                    // 创建内容项
                    const progress = calculateContentProgress(normalizedDateStr, index);
                    
                    const contentItem = document.createElement('div');
                    contentItem.className = 'content-item';
                    contentItem.innerHTML = `
                        <div class="content-text">
                            <div>${index + 1}、${content}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <div class="progress-text">记忆强度: ${progress}%</div>
                        </div>
                        <button class="delete-icon" data-date="${normalizedDateStr}" data-index="${index}" type="button">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    // 创建删除确认区域
                    const confirmArea = document.createElement('div');
                    confirmArea.className = 'delete-confirm-area';
                    confirmArea.id = `confirm-${normalizedDateStr}-${index}`;
                    confirmArea.innerHTML = `
                        <button class="delete-confirm-btn btn-confirm-delete" data-date="${normalizedDateStr}" data-index="${index}" data-action="confirm">
                            确认删除
                        </button>
                        <button class="delete-confirm-btn btn-cancel-delete" data-date="${normalizedDateStr}" data-index="${index}" data-action="cancel">
                            取消
                        </button>
                    `;
                    
                    wrapper.appendChild(contentItem);
                    wrapper.appendChild(confirmArea);
                    contentList.appendChild(wrapper);
                });
                
                // 绑定删除图标点击事件
                contentList.querySelectorAll('.delete-icon').forEach(icon => {
                    icon.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const dateStr = this.getAttribute('data-date');
                        const index = parseInt(this.getAttribute('data-index'));
                        deleteContent(dateStr, index, false);
                    });
                });
                
                // 绑定确认删除按钮事件
                contentList.querySelectorAll('.btn-confirm-delete').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const dateStr = this.getAttribute('data-date');
                        const index = parseInt(this.getAttribute('data-index'));
                        deleteContent(dateStr, index, true);
                    });
                });
                
                // 绑定取消删除按钮事件
                contentList.querySelectorAll('.btn-cancel-delete').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const dateStr = this.getAttribute('data-date');
                        const index = parseInt(this.getAttribute('data-index'));
                        cancelDelete(dateStr, index);
                    });
                });
            } else {
                contentList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>暂无错别字记录</p>
                    </div>
                `;
            }
        }
        
        // 保存数据到本地存储
        function saveData() {
            localStorage.setItem('learningData', JSON.stringify(learningData));
        }
        
        // 关闭模态框
        function closeModal() {
            // 停止所有听写
            stopDictation();
            
            document.getElementById('day-modal').style.display = 'none';
            document.getElementById('mastered-modal').style.display = 'none';
        }
        
        // 切换月份
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            initCalendar();
        });
        
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            initCalendar();
        });
        
        // 标签切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // 移除所有active类
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // 添加active类到当前标签
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-content`).classList.add('active');
                
                // 如果是复习标签页，检查语音支持
                if (tabId === 'review') {
                    checkVoiceSupport();
                }
            });
        });
        
        // 初始化
        initCalendar();
        
        // 点击模态框外部关闭
        window.addEventListener('click', (e) => {
            const modal1 = document.getElementById('day-modal');
            const modal2 = document.getElementById('mastered-modal');
            if (e.target === modal1 || e.target === modal2) {
                closeModal();
            }
        });
        
        // 为已学会卡片添加点击事件
        document.getElementById('mastered-card').addEventListener('click', showMasteredModal);
        
        // 为已学会模态框的关闭按钮添加事件
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', closeModal);
        });
        
        // 检查语音支持
        setTimeout(() => {
            checkVoiceSupport();
        }, 100);
    </script>
</body>
</html>